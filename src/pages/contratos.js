import { layout } from '../templates/layout.js';

export async function renderContratos(env) {
  let contratos = [];
  try {
    const result = await env.DB.prepare('SELECT ct.*, c.nome_empresa FROM contratos ct LEFT JOIN clientes c ON ct.cliente_id = c.id ORDER BY ct.created_at DESC').all();
    contratos = result.results || [];
  } catch (e) { console.error('Erro:', e); }

  const total = contratos.length;
  const pendentes = contratos.filter(c => c.status === 'pendente').length;
  const assinados = contratos.filter(c => c.status === 'assinado').length;
  const ativos = contratos.filter(c => c.status === 'ativo').length;

  let tableRows = '';
  if (contratos.length > 0) {
    tableRows = contratos.map(ct => {
      const statusClass = ct.status === 'ativo' ? 'badge-success' : (ct.status === 'assinado' ? 'badge-info' : 'badge-warning');
      return '<tr><td><span style="font-weight: 600; color: var(--primary);">#' + (ct.numero_contrato || ct.id) + '</span></td><td>' + (ct.nome_empresa || '-') + '</td><td style="font-family: monospace;">' + (ct.cnpj || '-') + '</td><td>' + (ct.data_inicio ? new Date(ct.data_inicio).toLocaleDateString('pt-BR') : '-') + '</td><td><span class="badge ' + statusClass + '">' + ct.status + '</span></td><td><div style="display: flex; gap: 8px;"><button class="btn btn-secondary btn-sm" onclick="showToast(\'Em desenvolvimento\')"><i class="fas fa-eye"></i></button></div></td></tr>';
    }).join('');
  } else {
    tableRows = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-file-signature" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.3;"></i>Nenhum contrato cadastrado.<br><button class="btn btn-primary" style="margin-top: 16px;" onclick="openModal(\'novoContratoModal\')"><i class="fas fa-plus"></i> Criar Primeiro Contrato</button></td></tr>';
  }

  const content = '<div class="page-header" style="display: flex; justify-content: space-between; align-items: center;"><div><h1 class="page-title">Contratos</h1><p class="page-subtitle">Gerencie contratos e documentacao</p></div><button class="btn btn-primary" onclick="openModal(\'novoContratoModal\')"><i class="fas fa-plus"></i> Novo Contrato</button></div><div class="grid grid-4"><div class="stat-card"><div class="stat-icon blue"><i class="fas fa-file-signature"></i></div><div class="stat-value">' + total + '</div><div class="stat-label">Total</div></div><div class="stat-card"><div class="stat-icon yellow"><i class="fas fa-hourglass-half"></i></div><div class="stat-value">' + pendentes + '</div><div class="stat-label">Aguardando</div></div><div class="stat-card"><div class="stat-icon green"><i class="fas fa-signature"></i></div><div class="stat-value">' + assinados + '</div><div class="stat-label">Assinados</div></div><div class="stat-card"><div class="stat-icon green"><i class="fas fa-check-double"></i></div><div class="stat-value">' + ativos + '</div><div class="stat-label">Ativos</div></div></div><div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-file-signature"></i> Lista de Contratos</h3><div style="display: flex; gap: 12px;"><a href="https://drive.google.com/drive/folders/1hTxC7rcN2MvAtusrG-gj6CxkT6FvhTe1" target="_blank" class="btn btn-secondary"><i class="fas fa-folder"></i> Modelos</a><a href="https://app.clicksign.com/" target="_blank" class="btn btn-secondary"><i class="fas fa-signature"></i> ClickSign</a></div></div><div class="table-container"><table><thead><tr><th>N Contrato</th><th>Cliente</th><th>CNPJ</th><th>Data Inicio</th><th>Status</th><th>Acoes</th></tr></thead><tbody>' + tableRows + '</tbody></table></div></div><div class="card" style="margin-top: 24px;"><div class="card-header"><h3 class="card-title"><i class="fas fa-lightbulb"></i> Passo a Passo para Contratos</h3></div><div class="grid grid-3" style="gap: 16px;"><div style="padding: 20px; background: var(--bg-dark); border-radius: 8px;"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><div style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">1</div><h4>Escolher Modelo</h4></div><p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">Acesse o Drive e escolha o modelo</p><a href="https://drive.google.com/drive/folders/1hTxC7rcN2MvAtusrG-gj6CxkT6FvhTe1" target="_blank" class="btn btn-secondary" style="width: 100%; justify-content: center;"><i class="fas fa-folder"></i> Abrir Drive</a></div><div style="padding: 20px; background: var(--bg-dark); border-radius: 8px;"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><div style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">2</div><h4>Enviar no ClickSign</h4></div><p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">Adicione documento e configure signatarios</p><a href="https://app.clicksign.com/" target="_blank" class="btn btn-secondary" style="width: 100%; justify-content: center;"><i class="fas fa-signature"></i> Abrir ClickSign</a></div><div style="padding: 20px; background: var(--bg-dark); border-radius: 8px;"><div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><div style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">3</div><h4>Criar Cobrancas</h4></div><p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">Crie mensalidade e implantacao</p><a href="https://www.asaas.com/customerAccount/list?caid=155676853" target="_blank" class="btn btn-secondary" style="width: 100%; justify-content: center;"><i class="fas fa-money-bill"></i> Abrir Asaas</a></div></div></div><div class="modal-overlay" id="novoContratoModal"><div class="modal" style="max-width: 700px;"><div class="modal-header"><h3 class="modal-title">Novo Contrato</h3><button class="modal-close" onclick="closeModal(\'novoContratoModal\')">&times;</button></div><form id="novoContratoForm" onsubmit="salvarContrato(event)"><div class="modal-body"><div class="form-group"><label class="form-label">Cliente (Nome da Empresa) *</label><input type="text" class="form-input" name="nome_empresa" required></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"><div class="form-group"><label class="form-label">CNPJ *</label><input type="text" class="form-input" name="cnpj" required placeholder="00.000.000/0000-00"></div><div class="form-group"><label class="form-label">CPF do Responsavel</label><input type="text" class="form-input" name="cpf_responsavel" placeholder="000.000.000-00"></div><div class="form-group"><label class="form-label">Email do Responsavel</label><input type="email" class="form-input" name="email_responsavel"></div><div class="form-group"><label class="form-label">Data de Inicio</label><input type="date" class="form-input" name="data_inicio"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal(\'novoContratoModal\')">Cancelar</button><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Contrato</button></div></form></div></div><script>async function salvarContrato(event){event.preventDefault();const form=event.target;const formData=new FormData(form);const data=Object.fromEntries(formData.entries());try{const response=await fetch("/api/contratos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});if(response.ok){showToast("Contrato salvo!");closeModal("novoContratoModal");setTimeout(()=>location.reload(),1000);}else{showToast("Erro ao salvar","error");}}catch(error){showToast("Erro ao salvar","error");}}</script>';

  return layout('Contratos', content, 'contratos');
}
