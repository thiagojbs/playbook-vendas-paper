import { layout } from '../templates/layout.js';

export async function renderClientes(env) {
  let clientes = [];
  try {
    const result = await env.DB.prepare('SELECT * FROM clientes ORDER BY created_at DESC').all();
    clientes = result.results || [];
  } catch (e) { console.error('Erro:', e); }

  let tableRows = '';
  if (clientes.length > 0) {
    tableRows = clientes.map(c => {
      const statusClass = c.status === 'cliente' ? 'badge-success' : 'badge-warning';
      return '<tr data-status="' + (c.status || 'lead') + '" data-nome="' + (c.nome_empresa || '').toLowerCase() + '"><td><div style="font-weight: 500;">' + (c.nome_empresa || '-') + '</div><div style="font-size: 12px; color: var(--text-secondary);">' + (c.ramo_negocio || '-') + '</div></td><td><div>' + (c.nome_responsavel || '-') + '</div><div style="font-size: 12px; color: var(--text-secondary);">' + (c.cargo || '-') + '</div></td><td><div style="font-size: 13px;">' + (c.telefone || '-') + '</div><div style="font-size: 12px; color: var(--text-secondary);">' + (c.email || '-') + '</div></td><td>' + (c.origem || '-') + '</td><td><span class="badge ' + statusClass + '">' + (c.status || 'lead') + '</span></td><td><div style="display: flex; gap: 8px;"><a href="/calculadora?cliente=' + c.id + '" class="btn btn-primary btn-sm"><i class="fas fa-file-invoice"></i></a></div></td></tr>';
    }).join('');
  } else {
    tableRows = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.3;"></i>Nenhum cliente cadastrado.<br><button class="btn btn-primary" style="margin-top: 16px;" onclick="openModal(\'novoClienteModal\')"><i class="fas fa-plus"></i> Cadastrar Primeiro Cliente</button></td></tr>';
  }

  const content = '<div class="page-header" style="display: flex; justify-content: space-between; align-items: center;"><div><h1 class="page-title">Clientes</h1><p class="page-subtitle">Gerencie sua base de clientes</p></div><button class="btn btn-primary" onclick="openModal(\'novoClienteModal\')"><i class="fas fa-plus"></i> Novo Cliente</button></div><div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-users"></i> Lista de Clientes</h3><div style="display: flex; gap: 12px;"><input type="text" class="form-input" placeholder="Buscar cliente..." style="width: 250px;" id="searchCliente" onkeyup="filtrarClientes()"><select class="form-select" style="width: 150px;" id="filterStatus" onchange="filtrarClientes()"><option value="">Todos</option><option value="lead">Lead</option><option value="qualificado">Qualificado</option><option value="proposta">Proposta</option><option value="cliente">Cliente</option></select></div></div><div class="table-container"><table><thead><tr><th>Empresa</th><th>Responsavel</th><th>Contato</th><th>Origem</th><th>Status</th><th>Acoes</th></tr></thead><tbody id="clientesTable">' + tableRows + '</tbody></table></div></div><div class="modal-overlay" id="novoClienteModal"><div class="modal" style="max-width: 800px;"><div class="modal-header"><h3 class="modal-title">Novo Cliente</h3><button class="modal-close" onclick="closeModal(\'novoClienteModal\')">&times;</button></div><form id="novoClienteForm" onsubmit="salvarCliente(event)"><div class="modal-body"><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"><div class="form-group"><label class="form-label">Nome da Empresa *</label><input type="text" class="form-input" name="nome_empresa" required></div><div class="form-group"><label class="form-label">Ramo do Negocio</label><input type="text" class="form-input" name="ramo_negocio"></div><div class="form-group"><label class="form-label">Nome do Responsavel</label><input type="text" class="form-input" name="nome_responsavel"></div><div class="form-group"><label class="form-label">Cargo</label><input type="text" class="form-input" name="cargo"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" name="email"></div><div class="form-group"><label class="form-label">Telefone</label><input type="text" class="form-input" name="telefone"></div><div class="form-group"><label class="form-label">Origem</label><select class="form-select" name="origem"><option value="">Selecione...</option><option value="Indicacao">Indicacao</option><option value="Prospeccao">Prospeccao</option><option value="Inbound">Inbound</option></select></div><div class="form-group"><label class="form-label">Status</label><select class="form-select" name="status"><option value="lead">Lead</option><option value="qualificado">Qualificado</option><option value="proposta">Proposta</option><option value="cliente">Cliente</option></select></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal(\'novoClienteModal\')">Cancelar</button><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar</button></div></form></div></div><script>function filtrarClientes(){const search=document.getElementById("searchCliente").value.toLowerCase();const status=document.getElementById("filterStatus").value;document.querySelectorAll("#clientesTable tr").forEach(row=>{const nome=row.dataset.nome||"";const rowStatus=row.dataset.status||"";row.style.display=nome.includes(search)&&(!status||rowStatus===status)?"":"none"});}async function salvarCliente(event){event.preventDefault();const form=event.target;const formData=new FormData(form);const data=Object.fromEntries(formData.entries());try{const response=await fetch("/api/clientes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});if(response.ok){showToast("Cliente salvo!");closeModal("novoClienteModal");setTimeout(()=>location.reload(),1000);}else{showToast("Erro ao salvar","error");}}catch(error){showToast("Erro ao salvar","error");}}</script>';

  return layout('Clientes', content, 'clientes');
}
